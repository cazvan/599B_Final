---
title: "How Did ACA Expansion Effect the Mental Health of Americans?"

author: "Caz VanDevere, Hanson Shi, & Ana Chkheidze"
date: "March 20, 2019"  
output:
  html_document:
    df_print: paged
  pdf_document: default
---
 
```{r, libraries, eval=TRUE, echo=FALSE}
# call libraries:
library(ggplot2)
library(haven)
library(Rmisc)
library(ggpubr)
library(tibble)
library(ggrepel)
library(magrittr)
library(dplyr)
library(reshape2)
library(Hmisc)
```

```{r, loaddata, eval=TRUE}
#import data (~250mb)-this chunk imports the original data file that was stored in dropbox:
# datalink='https://dl.dropboxusercontent.com/s/rpjq0x1bgzgdvh1/BRFSS599B.dta'
# brfssdata_orig=read_dta(datalink)
```

```{r loaddata3, eval=TRUE}
# #trim dataframe-because the original data file was 250mb, we need to trim it so it can be uploaded to GitHub. This chunk trims the data file and saves a csv in the working directory:
# brfssdata=brfssdata_orig%>% # make a new list from the original dataset
#    select(mental, stab, ex2014,ex2016, year)%>% # select the 5 variables we need for plots
#    filter(!is.na(stab))%>% # filter out n/a responses
#    filter(!is.na(mental))%>% # filter out n/a responses
#    filter(!is.na(year))%>% # filter out n/a responses
#    filter(!is.na(ex2014))%>% # filter out n/a responses
#    filter(!is.na(ex2016))%>% # filter out n/a responses
#    filter((year!=2018)) # filter responses from 2018 (it's a tiny sample and has weird averages)
# write.csv(brfssdata,"brfss.csv",row.names = FALSE) # write the list into a csv
# head(brfssdata) # look at the column names
# dim(brfssdata) # look at the dimensions
# brfssdata = read.csv("brfss.csv") # read back into RStudio if necessary
```

```{r loaddata2, eval=TRUE}
# #trim dataframe-this chunk also trims the original datafile into a smaller file, but saves different variables that are used in the multivariate plot:
# brfssdata2=brfssdata_orig%>% # create a second list from the original dataset, with different variables
#    select(mental, stab, ex2014,sex, year)%>% # select the 5 variables we need for plots
#    filter(!is.na(stab))%>% # filter out n/a responses
#    filter(!is.na(mental))%>% # filter out n/a responses
#    filter(!is.na(year))%>% # filter out n/a responses
#    filter(!is.na(ex2014))%>% # filter out n/a responses
#    filter(!is.na(sex))%>% # filter out n/a responses
#    filter((year!=2018)) # filter responses from 2018 (it's a tiny sample and has weird averages)
# write.csv(brfssdata2,"brfss2.csv",row.names = FALSE) # write the list to csv
# head(brfssdata2) # look at the column names
# dim(brfssdata2) # look at the dimensions
# brfssdata2 = read.csv("brfss2.csv") # 
```

```{r}
# import data (~90mb each)
#this chunk imports the csv files that the previous two chunks uploaded to Github. Because these files are under 100mb, they were able to be uploaded
brfssdata=read.csv("https://github.com/cazvan/599B_Final/raw/master/brfss.csv")
brfssdata2=read.csv("https://github.com/cazvan/599B_Final/raw/master/brfss2.csv")
```


```{r}
#This chunk removes states that do not fit neatly into the categories we use in our plots. These four states expanded ACA after 2014 ("AK" "LA" "MT" "PA") and are excluded from the results:
brfssdata$stab=as.character(brfssdata$stab) #convert stab into numeric
bad=unique(brfssdata$stab[(brfssdata$ex2014 == 0 & brfssdata$ex2016 == 1)]) #create a list of the bad states
bad # show us the bad states
```

```{r}
#Data prep for visualization: Calculate annual average negative mental days, grouped into expansion and non-expansion states
#pipe=%>% (this is from dplyr) 
dfmelt=brfssdata%>% #use main dataset
  select(year, stab, mental, ex2014)%>% #select these 4 variables for use
  filter(stab %nin% bad)%>% # filter out bad states
  filter(!is.na(ex2014))%>% #filter out n/a responses for ex2014 variable
  group_by(year,ex2014)%>% # group responeses by year then ex2014
  mutate(mentavg=mean(mental, na.rm = TRUE))%>% #create a new variable that is the average number of negative mental health days for each group created above
  ungroup()%>% # ungroup the groups
  select(year, ex2014,mentavg)%>% #select the year, ex2014, and newly created mentavg variables
  unique()%>% #only look at unique responses
  mutate(ex2014=ifelse(ex2014==0, "No Expansion", "Expansion")) #change the binary reponses to string responses
#View(dfmelt) # view the dataframe to verify results
```

```{r}
#Data prep for visualization: Calculate annual average negative mental days, ungrouped (expansion and non-expansion groups together)
#pipe=%>% (this is from dplyr) 
dfmelt2=brfssdata%>% #use main dataset
  select(year, stab, mental)%>% #select the 3 variables to be used
  filter(stab %nin% bad)%>% # filter out the bad states
  group_by(year)%>% # group by year
  mutate(mentavg2=mean(mental, na.rm = TRUE))%>% # make a new variable for average negative mental days per year
  ungroup()%>% # ungroup
  select(year,mentavg2)%>% # select year and mentavg variables
  unique() # only look at unique responses
#View(dfmelt2)
```

```{r}
#Data prep for multivariate visualization, averaging annual negative mental health days by year, sex, and expansion vs. non-expansion state
#pipe=%>% (this is from dplyr) 
dfsex=brfssdata2%>% # name the new frame, use the second list
  select(year, stab, mental, ex2014, sex)%>% #select the variables to be used
  filter(stab %nin% bad)%>% #filter out the bad states
  filter(!is.na(ex2014))%>% #filter out n/a answers from ex2014
  group_by(sex,year,ex2014)%>% #group by sec, year, and ex2014 variables
  mutate(mentavg=mean(mental, na.rm = TRUE))%>% #create a new variable for average mental days by sex,year, and expansion group
  ungroup()%>% #ungroup the grouped variables
  select(year, ex2014,mentavg,sex)%>% #select the 4 variables to be used
  unique()%>% #group into unique answers
  mutate(ex2014=ifelse(ex2014==0, "No ACA Expansion", "ACA Expansion"))%>% #rename expansion variable
  filter((year!=2018)) #remove responses from 2018

#rename the binary sex variable to "male" and "female"
dfsex$sex <- ordered(dfsex$sex, #order the variable from 1 to 0
  levels = c(1,0), #select the binary numbers
  labels = c("Males", "Females")) # choose the new names

#View(dfsex)
```

```{r}
#Univariate Visualization: barplot
source1="BRFSS Survey Data 2000-2018" #source
titlecount="Survey Count by Year" #title for the plot

yearplot=ggplot(data= brfssdata, aes(x=year)) + # create the yearplot object using the main dataset
  geom_bar(stat = "count", fill="steelblue") + # make the yearplot into a barplot, color it
  labs(title=titlecount, x=NULL, y=NULL,caption=source1) + # use the labels created above
  scale_y_continuous(labels = scales::comma) + # set the scale for the y axis
  scale_x_continuous(breaks=c(2000:2017)) + # set the scale for the years on the x axis
  theme(panel.background = element_rect(fill = "white",colour = "grey50"), # choose background colors
                              plot.caption = element_text(hjust = 0), # default was 1 #set caption position 
                              plot.title = element_text(hjust = 0.5), # set title position
                              axis.text.x = element_text(angle = -30, hjust = 0)) # adjust the x axis labels
yearplot # display the year plot
```

```{r}
#Univariate Visualization: Line Plot NEW YAY
source1="BRFSS Survey Data 2000-2018" #source
title1="Average Negative Mental Health Days Over Last 30 Days" #title for the plot

ggplot(dfmelt2,aes(x=year, y = mentavg2)) + #create the lineplot using the new dataset
  labs(title=title1, x="Year", y="Days",caption=source1) + # use the labels created above
  geom_line(color="steelblue",aes(), show.legend = TRUE) + # color the line
  #geom_vline(xintercept=2014) +
  scale_x_continuous(breaks=c(2000:2017)) + #showing the exact year changes from 2000 to 2017 on x axis
  theme(panel.background = element_rect(fill = "white",colour = "grey50"), # add plot theme and background colors
                              plot.caption = element_text(hjust = 0), # default was 1, set caption position
                              plot.title = element_text(hjust = 0.5), # set title position
                              axis.text.x = element_text(angle = 30, hjust = 1)) + # adjust the x axis labels
  geom_hline(yintercept = mean(dfmelt2$mentavg2), # add horizontal average line
                           linetype="dashed", # make a dashed line 
                           size=1, # change the line thickness
                           alpha=0.5)+ # change the line depth
  theme(legend.title = element_blank())+ # get rid of legend 
  annotate("text",x=2017,y=3.455,label="mean",size=3,alpha=0.7) # position the label 
                          
```

```{r}
# Bi-variate Visualization: Line plot
## this plot shows the average mental health number reported each year for states that expanded ACA vs. states that didnt expand ACA.
titlebi="Average Negative Mental Health Days Over Last 30 Days" # source
source1="BRFSS Survey Data 2000-2018" # title for the plot
ggplot(dfmelt, aes(x=year, y = mentavg, group = ex2014)) + # create the line plot using the new dataset
  labs(title=titlebi, x="Years", y="Average Mental Health Days",caption=source1) + # use the labels create above
  geom_line(aes(color=ex2014)) + # add the lines for each catagory 
  geom_vline(xintercept=2014,size=1, alpha=0.5) + # add the vertical Expansion line on year 2014
  scale_x_continuous(breaks=c(2000:2017)) + # change the x axis breaks to show each year from 2000 to 2017
  theme(panel.background = element_rect(fill = "white",colour = "grey50"), # change the background color
                              plot.caption = element_text(hjust = 0), # default was 1, set caption position
                              plot.title = element_text(hjust = 0.5), # set title position
                              axis.text.x = element_text(angle = 30, hjust = 1))+ # adjust the x axis labels
    geom_hline(yintercept = mean(dfmelt2$mentavg2), # add horizontal average line
                           linetype="dashed", # make a dashed line
                           size=1, # change the line thickness 
                           alpha=0.5)+ # change line depth
  theme(legend.title = element_blank())+ # get rid of the legend
annotate("text",x=2017,y=3.455,label="mean",size=3,alpha=0.7)+ # position the mean label
annotate("text",x=2015.59,y=3.28,label="ACA Expansion",size=3,alpha=0.7)+ # position the ACA Expension label
 scale_color_manual(values = c("steelblue","darkred")) # manually change the line colors
  #scale_y_continuous(expand = 
  #facet_grid(ex2014~.) #gender? Income bracket?

#add mean behavior line? Add annotation instead of reference line for 2014?
```

We broke the analysis further down to examine the effects of ACA expansion on male and female respondents. Evidently, ACA expansion had similar effects on both groups in ACA and non ACA states, i.e. both groups experienced deteriorating mental health from that point onward. Moreover, the analysis shows an interesting result: on average, female respondents experienced more negative mental health days compared to their male counterparts for 18 years. 
```{r multivar, eval=TRUE}
# Multi-variate Visualization: line plot for sex, income, and education level:
## this plot shows the average mental health number reported each year for 
## states that expanded ACA vs. states that didnt expand ACA
titlesex="Negative Mental Health Days by Sex by Expansion Group" #give a title to the graph

ggplot(dfsex, aes(x=year, y = mentavg, group = sex)) + #create a lineplot using dfsex frame 
  geom_line(aes(color=sex)) + # add a line to mark average mental days for 2 groups
  geom_vline(xintercept=2014) + #add a vertical line to mark expansion year
  scale_x_continuous(breaks=c(2000:2017)) + #include years 2000-2017
  scale_y_continuous(breaks=c(1,1.2,1.4,1.6,1.8,2,2.2,2.4,2.6,2.8,3,3.2,3.4,3.6,3.8,4,4.2)) +
  #adjusting the y axis scale
  labs(title=titlesex, x="Year", y="Days",caption=source1) + #give labels to the axis and     adding source
  theme(panel.background = element_rect(fill = "white",colour = "grey50"), #change background                               color
                              plot.caption = element_text(hjust = 0),# adjust caption position
                              plot.title = element_text(hjust = 0.5), # adjust title position
                              axis.text.x = element_text(angle = 30, hjust = 1)) + #adjust x                                axis to have an angle
  facet_grid(ex2014~.) + #create two graphs according to ex2014
  geom_hline(yintercept = mean(dfmelt2$mentavg2), #dd a horizontal line for the total mean
                           linetype="dashed", #type of line
                           size=1, #thickness
                           alpha=0.5)+ #transparency
  theme(legend.title = element_blank())+ #get rid of the legend title
  annotate("text",x=2017,y=3.55,label="mean",size=3,alpha=0.7)+ #position text 'mean'
  annotate("text",x=2012.5,y=2.25,label="ACA Expansion",size=3,alpha=0.7)+ #position text 'ACA   Expansion'
  scale_color_manual(values = c("steelblue","darkred")) #manually add the colors to the lines   for males/females

```
